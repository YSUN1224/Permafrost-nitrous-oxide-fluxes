#!/usr/bin/env bash
#SBATCH -J trim
#SBATCH -c 8
#SBATCH --mem=24G
#SBATCH -t 06:00:00
#SBATCH -o logs/trim_%A_%a.out
#SBATCH -e logs/trim_%A_%a.err
#SBATCH --array=1-999%50

set -euo pipefail

TSV="metadata/samples.tsv"
TRIMDIR="work/00_trim"
mkdir -p logs "$TRIMDIR"

# pick the Nth sample row (skip header)
LINE=$(awk -v n=$SLURM_ARRAY_TASK_ID 'NR==n+1{print; exit}' "$TSV")
[[ -n "$LINE" ]] || { echo "No line for task $SLURM_ARRAY_TASK_ID"; exit 0; }

sample_id=$(echo "$LINE" | cut -f1)

export THREADS=$SLURM_CPUS_PER_TASK
bash scripts/00_trim_trimmomatic.sh "$TSV" "$TRIMDIR"
echo "Done trimming (task sample: $sample_id)"

N=$(($(wc -l < metadata/samples.tsv) - 1))
sbatch --array=1-${N}%50 slurm/trim.sbatch
